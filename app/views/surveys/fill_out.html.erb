<div class="container">
  Fill out Survey page
  <div>
  	<h1 data-bind="text: title"></h1>
  		<center>
  		<div id="surveyContainer" >
		  	<div data-bind="foreach: inputs">
		  		<div class="questionContainer" data-bind=" style: { opacity: $parent.currentQuestion()==$index() ? 1 : 0.3 }, attr: { id:$index()}">
		  			<div  data-bind=" style: { marginTop: input_type=='location' ? '' : '125px'}">
				  		<h4 data-bind="text: ($index() + 1) + '. ' + label"></h4>
				  		<div data-bind="if: input_type=='text'">
				  			<textarea data-bind="value: $parent.surveyAnswers[$index()].value, event:{change: $parent.next}" type="textarea"></textarea>
				  		</div>

				  		<div data-bind="if: input_type=='select1'">
				  			<select data-bind="foreach: options, value: $parent.surveyAnswers[$index()].value, event:{change: $parent.next}">
				  				<option data-bind="text: $data">
				  				</option>
				  			</select>
				  		</div>

				  		<div data-bind="if: input_type=='image'">
				  			<input data-bind="file: $parent.surveyAnswers[$index()].value" type="file" accept="image/*" />
				  		</div>

				  		<div data-bind="if: input_type=='location'">
				  			<div data-bind="style:{width:'300px',height:'300px'},map: $parent.position"></div>
				  			<input type="text" data-bind="value: $parent.address"> <button data-bind ="click: $parent.getAddressLatLng">Submit</button>
				  		</div>
			  		</div>
			  	</div>
		  	</div>
	  		<button data-bind="click: result">Click here</button>
	  	</div>

  	<div class="navigation">
	  	<button data-bind="click: previous">^</button>
	  	<button data-bind="click: next">v</button>
	  	<div>
	  		<h1 class="progressTracker" data-bind=""></h1>
	  	</div>
	</div>
		</center>
  </div>
</div>

<script type="text/javascript">
  PT.retrieveSurveyDefinition(<%= @code %>, function(data){
  	//Data to send out

  	var surveyAnswers =[]
  	for(i=0;i<data.inputs.length;i++){
  		surveyAnswers.push({
  		  	id: data.inputs[i].id,
  		  	value : ko.observable(''),
  		  	input_type: data.inputs[i].input_type
  		  })
  	}

  	var currentPosition = ko.observable({
  		lat:ko.observable(0), 
		lng:ko.observable(0)
  	})

	var viewModel = {
	  		title : data.title,
	  		inputs : data.inputs,
	  		id: data.id,
	  		surveyAnswers : surveyAnswers,
	  		address: ko.observable(),

	  		result: function(){
	  			var id = this.id
	  			var answers = ko.toJS(this.surveyAnswers)
	  			var data = {
	  				installation_id:"",
	  				timestamp:"",
	  				locationStamp: {
	  					lat:"",
	  					lon:""
	  				},
	  				survey_id: id,
	  				answers: answers
	  			}
	  			console.log(data)
	  			$.ajax({
	  				url: "http://dev.aggregate.promisetracker.org/responses",
	  				type: 'post', 
	  				data: {response:JSON.stringify(data)},
	  				dataType: 'json',
	  				headers: { Authorization : '85823f6d6a9167b1ff947a18b176c09a'},
	  				success : function(returnedData) {
	  				  	console.info(returnedData)   
	  				}})
	  		},

	  		currentQuestion: ko.observable(0),

	  		next: function(){
	  			var previousVal = this.currentQuestion();

	  			if(previousVal == this.inputs.length-1){
	  				return
	  			}else{
	  				this.currentQuestion(previousVal + 1)
	  			}
	  			window.location.hash = "#"+this.currentQuestion()
	  		},
	  		previous: function(){
	  			var previousVal = this.currentQuestion();
	  			if(previousVal == 0){
	  				return
	  			}else{
	  				this.currentQuestion(previousVal - 1)
	  			}
	  			window.location.hash = "#"+this.currentQuestion()
	  		},
	  		position : currentPosition,
	  		getAddressLatLng: function(){
				geocoder = new google.maps.Geocoder();

				geocoder.geocode({'address': viewModel.address()}, function(results,status){
					if(status == google.maps.GeocoderStatus.OK){
						console.log(results[0].geometry.location.lat())
						viewModel.position({
				 		 	lat:ko.observable(results[0].geometry.location.lat()), 
				 		 	lng:ko.observable(results[0].geometry.location.lng())
				 		 })
					}
					else {
		            alert( 'Geocode was not successful for the following reason: ' + status );
		        	}
				})
			}
	  	}

	navigator.geolocation.getCurrentPosition(
		function(position){
		 	viewModel.position({
		 		 	lat:ko.observable(position.coords.latitude), 
		 		 	lng:ko.observable(position.coords.longitude)
		 		 })
		    
		}
	);

	ko.bindingHandlers.map = {
  		init: function(element, valueAccessor,allBindingsAccessor,input){
  			console.log(input)

  			var mapObj = ko.utils.unwrapObservable(valueAccessor());

  			var latLng = new google.maps.LatLng(
  				ko.utils.unwrapObservable(mapObj.lat),
  				ko.utils.unwrapObservable(mapObj.lng))

  			var mapOptions = {
  				center: latLng,
  				zoom: 10,
  			}

  			mapObj.googleMap = new google.maps.Map(element, mapOptions)
  			mapObj.marker = new google.maps.Marker({position: latLng,
  				map: mapObj.googleMap,
  				draggable:true,
  				animation: google.maps.Animation.DROP
  			})

  			viewModel.marker = mapObj.marker
  			viewModel.map = mapObj.googleMap

  			google.maps.event.addListener(mapObj.marker,'dragend',function(){
  				viewModel.marker = this

  				var index = viewModel.surveyAnswers.findIndex(function(i){
  					return i.id == input.id
  				})

  				viewModel.surveyAnswers[index].value = {
  					lat:viewModel.marker.getPosition().lat(),
  					lon:viewModel.marker.getPosition().lat()
  				}
  				console.log(viewModel)
  			})
  		},
	  	update: function(element,valueAccessor,allBindingsAccessor){
	  		var mapObj = ko.utils.unwrapObservable(allBindingsAccessor().map);
	  		var latLng = new google.maps.LatLng(
  				ko.utils.unwrapObservable(mapObj.lat),
  				ko.utils.unwrapObservable(mapObj.lng))
	  		console.log(latLng)
	  		viewModel.marker.setPosition(latLng)
	  		viewModel.map.center = latLng
	  		}
  	}

  	ko.applyBindings(viewModel)

  	for(i=0;i<surveyAnswers.length;i++){
  		this["waypoint"+i] = new Waypoint({
  		 	element: document.getElementById(i),
  		 	handler: function(){
  		 		viewModel.currentQuestion(parseInt(this.element.id))
  		 		console.log(viewModel.currentQuestion())
  		 	},
  		 	offset:'30%'
  		 })
  	}
	
  	
  });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYrqOLLhjp7hWkDBf7NmrVxw-IPt3p-e0">
</script>
